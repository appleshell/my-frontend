---
title: 浏览器的多进程架构
---

## 进程和线程

在讲进程和线程之前，要先理解什么是并行处理

### 什么是并行处理

顾名思义，计算机中的并行处理就是同一时刻处理多个任务。

并行处理需要依赖于多线程，使用多线程同时执行多个任务，实现并行处理，大大提升性能。

### 线程 VS 进程

多线程可以并行处理任务，但**线程是不能单独存在的，它是由进程来启动和管理的**。

**一个进程就是一个程序的运行实例**。详细解释是：启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫进程。

线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率。

总结来说，进程和线程之间的关系有以下4个特点：

1. 进程中的任一线程执行出错，都会导致整个进程崩溃。

2. 线程之间共享进程中的数据。

3. 当一个进程关闭之后，操作系统会回收进程所占用的内存。

4. 进程之间的内容相互隔离。如果进程之间需要进行数据的通信，就需要使用用于进程间通信（IPC）的机制了。

## 单进程浏览器时代

单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里，这些模块包括了网络、插件、JavaScript运行环境、渲染引擎和页面等。单进程浏览器的架构如下图：

![单进程浏览器](https://static001.geekbang.org/resource/image/6d/ca/6ddad2419b049b0eb2a8036f3dfff1ca.png)

如此多的功能模块运行在一个进程里，是导致单进程浏览器不稳定、不流畅和不安全的一个主要因素：

### 问题1：不稳定

插件、渲染引擎模块是不稳定的，这些模块运行在浏览器进程中，它们的崩溃会导致整个浏览器的崩溃。

### 问题2：不流畅

由上图可知，在页面线程中运行着多个模块，这意味着同一时刻只能执行一个模块，如果某个模块无限循环，就会导致该线程中的其他模块不能执行，进而是浏览器没有响应，变得卡顿。

此外，页面的内存泄漏会导致内存占用越来越高，浏览器变得越来越慢。

### 问题3：不安全

插件，页面脚本可以获取操作系统的资源和权限，从而引发安全问题。

## 多进程浏览器时代

上述问题已被现代浏览器解决了，方法就是多进程浏览器。

### 早期多进程架构

下如是2008年Chrome发布时的进程架构：

![早期chrome多进程架构](https://static001.geekbang.org/resource/image/cd/60/cdc9215e6c6377fc965b7fac8c3ec960.png)

可以看出，插件、页面等模块都有各自的进程，进程之间通过IPC机制进行通信。

1. 解决不稳定。

    由于进程是相互隔离的，所以一个页面的或插件的崩溃只会影响到当前的页面进程或者插件进程，不会影响到浏览器和其他页面。

2. 解决不流畅。

    和上面的原理一样，当一个进程被阻塞时，也只是当前的页面受到影响，因为其他页面是运行在它们自己的渲染进程中的。

    对于内存泄漏，因为关闭一个页面时，整个渲染进程也会被关闭，之后该进程所占用的内存都会被回收。

3. 解决不安全。

    多进程架构的额外好处是可以使用安全沙箱，可以看成是操作系统给进程上了一把锁，沙箱内的程序可以运行，但不能在硬盘上读写，不能再敏感位置读取任何数据。

### 目前多进程架构

![目前多进程架构](https://static001.geekbang.org/resource/image/b6/fc/b61cab529fa31301bde290813b4587fc.png)

从图中可以看出，最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

* **浏览器进程**：主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。

* **渲染进程**：核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。

* **GPU进程**：绘制网页、Chrome的UI界面、3D CSS效果等。

* **网络进程**：主要负责页面的网络资源加载。

* **插件进程**：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

### 未来面向服务的架构

2016年，Chrome官方团队使用**面向服务的架构**（Services Oriented Architecture，简称SOA）的思想重新设计了新的Chrome架构。原来的各种模块会被重构成独立的服务（Service），每个服务都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统。

下面是 Chrome“面向服务的架构”的进程模型图：
![面向服务的架构](https://static001.geekbang.org/resource/image/32/2a/329658fe821252db47b0964037a1de2a.png)